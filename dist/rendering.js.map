{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import './css/sunburst.css!';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport d3 from './d3.v3.min';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  var formater = [];\n\n  elem = elem.find('.sunburst');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addSunburst();\n    }\n  }\n\n  function createValueFormater(style) {\n    var defaultFormater = function(v) {\n      return v;\n    };\n\n    if (! style) {\n      return defaultFormater;\n    }\n\n    switch (style.type) {\n    case 'date':\n      var dateFormater = function(v) {\n        v = parseFloat(v);\n        var date = moment(v);\n        if (ctrl.dashboard.isTimezoneUtc()) {\n          date = date.utc();\n        }\n        return date.format(style.dateFormat || 'YYYY-MM-DD HH:mm:ss');\n      };\n      return dateFormater;\n      break;\n\n    case 'number':\n      var numberFormater = function(v) {\n        var valueFormater = kbn.valueFormats[style.unit];\n        v = parseFloat(v);\n        return valueFormater(v, style.decimals, null);\n      };\n      return numberFormater;\n      break;\n\n    default:\n      return defaultFormater;\n    }\n  }\n\n  function addSunburst() {\n    if (data.length === 0 || data[0].datapoints.length === 0) {\n      return;\n    }\n\n    // Prepare <svg> and <g>\n    var elemWidth = elem.width();\n    var elemHeight = elem.height();\n    var margin = { top: 10, right: 10, bottom: 10, left: 10 };\n    var tooltipHeight = 25;\n    var sidebarWidth = 100;\n    var width = elemWidth - margin.left - margin.right - sidebarWidth;\n    var height = elemHeight - margin.top - margin.bottom - tooltipHeight;\n    var radius = Math.min(width, height) / 2;\n\n    d3.select(\"#sunburst-g-\" + ctrl.panel.id).remove();\n\n    var svg = d3.select(\"#sunburst-svg-\" + ctrl.panel.id)\n      .attr(\"width\", width + margin.left + margin.right)\n      .attr(\"height\", height + margin.top + margin.bottom)\n    .append('g')\n      .attr('id', \"sunburst-g-\" + ctrl.panel.id)\n      .attr(\"transform\", \"translate(\" +\n        (margin.left + width  / 2) + \", \" +\n        (margin.top  + height / 2) + \")\"\n      );\n\n    var x = d3.scale.linear().range([0, 2 * Math.PI]);\n    var y = d3.scale.sqrt().range([0, radius]);\n\n    var partition = d3.layout.partition()\n      .children(function(d) {\n        return Array.isArray(d.values) ?\n          d.values : null;\n      })\n      .value(function(d) {\n        return d.values;\n      });\n\n    // Load data\n    var hierarchy = _createHierarchy(data[0].datapoints);\n\n    d3.csv(\"dummy\", function(error, dataset) {\n      // Set colors\n      var color = function(d) {\n        var colors;\n\n        if (!d.parent) {\n          var scale;\n\n          if (hierarchy.values.length < 10) {\n            scale = d3.scale.category10();\n          } else {\n            scale = d3.scale.category20();\n          }\n          colors = scale.domain(d3.range(0, 10));\n          d.color = 'transparent';\n\n        } else if (d.children) {\n          var startColor = d3.hcl(d.color).darker();\n          var endColor   = d3.hcl(d.color).brighter();\n\n          colors = d3.scale.linear()\n            .interpolate(d3.interpolateHcl)\n            .range([\n              startColor.toString(),\n              endColor.toString()\n            ])\n            .domain([0, d.children.length + 1]);\n        }\n\n        if (d.children) {\n          d.children.map(function(child, i) {\n            return { value: child.value, idx: i};\n          })\n          .sort(function(a,b) {\n            return b.value - a.value\n          })\n          .forEach(function(child, i) {\n            d.children[child.idx].color = colors(i);\n          });\n        }\n\n        return d.color;\n      };\n\n      // Draw\n      var path = svg.selectAll(\"path\")\n        .data(partition.nodes(hierarchy))\n        .enter()\n        .append(\"path\")\n        .attr(\"d\", arc)\n        .attr(\"stroke\", \"#fff\")\n        .attr(\"fill-rule\", \"evenodd\")\n        .attr(\"fill\", color)\n        .on(\"click\", click)\n        .on(\"mouseover\", mouseover)\n        .on(\"mouseout\", mouseout);\n\n      // Set tooltip\n      var tooltip = d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id + ' > a')\n        .attr('href', panel.linkPrefix)\n        .text(panel.rootKey + ': ' + _formatValue(hierarchy.value, panel.nodeKeys.length - 1));\n\n      // Set legend\n      d3.select('#sunburst-toggle-' + ctrl.panel.id)\n        .on(\"click\", toggleLegend);\n\n      // Set actions\n      function click(d) {\n        path.transition()\n         .duration(750)\n         .attrTween(\"d\", arcTween(d));\n\n        mouseout();\n      };\n\n      function mouseover(d) {\n        _updateTooltip(d);\n        _updateLegend(d);\n      };\n\n      function mouseout() {\n        _removeLegend();\n      };\n    });\n\n    var arc = d3.svg.arc()\n      .startAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));\n      })\n      .endAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));\n      })\n      .innerRadius(function(d) {\n        return Math.max(0, y(d.y));\n      })\n      .outerRadius(function(d) {\n        return Math.max(0, y(d.y + d.dy));\n      });\n\n    function arcTween(d) {\n      var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]);\n      var yd = d3.interpolate(y.domain(), [d.y, 1]);\n      var yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);\n\n      return function(d, i) {\n        return i ?\n          function(t) {\n            return arc(d);\n          } :\n          function(t) {\n            x.domain(xd(t));\n            y.domain(yd(t)).range(yr(t));\n            return arc(d);\n          };\n      };\n    }\n\n    function _createHierarchy(datapoints) {\n      panel.nodeKeys = _.keys(datapoints[0]);\n\n      var nest = d3.nest();\n      _.each(panel.nodeKeys, function(key, depth) {\n        formater[depth] = createValueFormater(panel.styles[key]);\n\n        if (depth !== panel.nodeKeys.length - 1) {\n          nest = nest.key(function(d) { return d[key]; });\n        } else {\n          nest = nest.rollup(function(leaves) {\n            return leaves[0][key];\n          });\n        }\n      });\n\n      var hierarchy = {\n        key: panel.rootKey,\n        values: nest.entries(datapoints)\n      };\n\n      return hierarchy;\n    }\n\n    function _getNodeArray(d) {\n      var nodeArray = [];\n      var current = d;\n      while (current.parent) {\n        nodeArray.unshift(current);\n        current = current.parent;\n      }\n      return nodeArray;\n    }\n\n    function _formatValue(value, depth) {\n      if (formater[depth]) {\n        var valueFormater = formater[depth];\n        value = valueFormater(value);\n      }\n\n      return value;\n    }\n\n    function _updateTooltip(d) {\n      var nodeArray = _getNodeArray(d);\n\n      var nodePath = '';\n      var linkParams = [];\n      if (nodeArray.length > 0) {\n        var formatedKeys = [];\n        _.each (nodeArray, function(node, i) {\n          formatedKeys[i] = _formatValue(node.key, node.depth - 1)\n          linkParams[i] = panel.nodeKeys[i] + '=' + node.key;\n        });\n\n        nodePath = formatedKeys.join(' > ');\n\n      } else {\n        nodePath = panel.rootKey;\n      }\n\n      var value = _formatValue(d.value, panel.nodeKeys.length - 1);\n\n      var tooltipHref = null;\n      if (panel.linkPrefix) {\n        var delimiter = (panel.linkPrefix.indexOf('\\?') != -1) ? '&' : '?';\n        tooltipHref = panel.linkPrefix + delimiter + linkParams.join('&');\n      }\n\n      d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id + ' > a')\n      .attr('href', tooltipHref)\n      .text(nodePath + \": \" + value)\n        .transition()\n        .attr(\"fill-opacity\", 1);\n    }\n\n    function _removeLegend() {\n      d3.select('#sunburst-legend-' + ctrl.panel.id + ' > svg').remove();\n    }\n\n    function _updateLegend(d) {\n      _removeLegend();\n\n      if (d.values === undefined) {\n        return;\n      }\n      var colors = [];\n      _.each(d.values, function(node) {\n        colors[node.key] = node.color ;\n      });\n\n      var li = {\n        w: 75, h: 30, s: 3, r: 3\n      };\n\n      var legend = d3.select('#sunburst-legend-' + ctrl.panel.id)\n          .append('svg')\n          .attr(\"width\", li.w)\n          .attr(\"height\", d3.keys(colors).length * (li.h + li.s));\n\n      var g = legend.selectAll(\"g\")\n          .data(d3.entries(colors))\n          .enter().append(\"svg:g\")\n          .attr(\"transform\", function(d, i) {\n                  return \"translate(0,\" + i * (li.h + li.s) + \")\";\n               });\n\n      g.append(\"svg:rect\")\n          .attr(\"rx\", li.r)\n          .attr(\"ry\", li.r)\n          .attr(\"width\", li.w)\n          .attr(\"height\", li.h)\n          .style(\"fill\", function(d) { return d.value; });\n\n      g.append(\"svg:text\")\n          .attr(\"x\", li.w / 2)\n          .attr(\"y\", li.h / 2)\n          .attr(\"dy\", \"0.35em\")\n          .attr(\"text-anchor\", \"middle\")\n          .style('font-size', '7')\n          .style('fill', '#fff')\n          .text(function(d) {\n              return _formatValue(d.key, d.depth);\n          });\n    }\n\n    function toggleLegend() {\n      var legend = d3.select('#sunburst-legend-' + ctrl.panel.id);\n      var checked = d3.select('#sunburst-sidebar-' + ctrl.panel.id).prop('checked');\n\n      if (checked) {\n        legend.style(\"visibility\", \"\");\n      } else {\n        legend.style(\"visibility\", \"hidden\");\n      }\n    }\n  }\n}\n\n"]}