{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import './css/sunburst.css!';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\nimport d3 from './d3.v3.min';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  var formaters = [];\n\n  elem = elem.find('.sunburst');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addSunburst();\n    }\n  }\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function addSunburst() {\n    // Prepare data\n    if (data.length === 0 || data[0].datapoints.length === 0) {\n      return;\n    }\n    var rawData = data[0].datapoints;\n    var hierarchy = createHierarchy(rawData);\n\n    panel.nodeKeys = _.keys(rawData[0]);\n\n    var partition = d3.layout.partition()\n      .children(function(d) {\n        return Array.isArray(d.values) ?\n          d.values : null;\n      })\n      .value(function(d) {\n        return d.values;\n      });\n\n    // Configure graph size\n    var elemWidth = elem.width();\n    var elemHeight = elem.height();\n    var margin = { top: 10, right: 10, bottom: 10, left: 10 };\n    var width = elemWidth - margin.left - margin.right;\n    var height = elemHeight - margin.top - margin.bottom;\n    var radius = Math.min(width, height) / 2;\n\n    // Configure actions\n    var color = function(d) {\n      var colors;\n\n      if (! d.parent) {\n        var scale;\n\n        if (hierarchy.values.length < 10) {\n          scale = d3.scale.category10();\n        } else {\n          scale = d3.scale.category20();\n        }\n        colors = scale.domain(d3.range(0, 10));\n        d.color = 'transparent';\n\n      } else if (d.children) {\n        var startColor = d3.hcl(d.color).darker();\n        var endColor   = d3.hcl(d.color).brighter();\n\n        colors = d3.scale.linear()\n          .interpolate(d3.interpolateHcl)\n          .range([\n            startColor.toString(),\n            endColor.toString()\n          ])\n          .domain([0, d.children.length + 1]);\n      }\n\n      if (d.children) {\n        d.children.map(function(child, i) {\n          return { value: child.value, idx: i};\n        })\n        .sort(function(a,b) {\n          return b.value - a.value\n        })\n        .forEach(function(child, i) {\n          d.children[child.idx].color = colors(i);\n        });\n      }\n\n      return d.color;\n    };\n\n    var mouseout = function(d) {\n    };\n\n    var click = function(d) {\n      svg.selectAll(\"path\")\n       .transition()\n       .duration(750)\n       .attrTween(\"d\", arcTween(d));\n\n      mouseout();\n    };\n\n    var mouseover = function(d) {\n      var position = d3.mouse(d3.select('#sunburst-div-' + ctrl.panel.id).node());\n      updateTooltip(d, position);\n    };\n\n    var x = d3.scale.linear().range([0, 2 * Math.PI]);\n    var y = d3.scale.sqrt().range([0, radius]);\n\n    var arc = d3.svg.arc()\n      .startAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x)));\n      })\n      .endAngle(function(d) {\n        return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));\n      })\n      .innerRadius(function(d) {\n        return Math.max(0, y(d.y));\n      })\n      .outerRadius(function(d) {\n        return Math.max(0, y(d.y + d.dy));\n      });\n\n    var arcTween = function(d) {\n      var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]);\n      var yd = d3.interpolate(y.domain(), [d.y, 1]);\n      var yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);\n\n      return function(d, i) {\n        return i ?\n          function(t) {\n            return arc(d);\n          } :\n          function(t) {\n            x.domain(xd(t));\n            y.domain(yd(t)).range(yr(t));\n            return arc(d);\n          };\n      };\n    };\n\n    // Draw graph\n    d3.select(\"#sunburst-g-\" + ctrl.panel.id).remove();\n\n    var svg = d3.select(\"#sunburst-svg-\" + ctrl.panel.id)\n      .attr(\"width\", width + margin.left + margin.right)\n      .attr(\"height\", height + margin.top + margin.bottom)\n      .on(\"click\", function() {\n        d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n          .classed('hidden', true);\n      })\n    .append('g')\n      .attr('id', \"sunburst-g-\" + ctrl.panel.id)\n      .attr(\"transform\", \"translate(\" +\n        (margin.left + width  / 2) + \", \" +\n        (margin.top  + height / 2) + \")\"\n      );\n\n    var path = svg.selectAll(\"path\")\n      .data(partition.nodes(hierarchy))\n      .enter()\n    .append(\"path\")\n      .attr(\"d\", arc)\n      .attr(\"stroke\", \"#fff\")\n      .attr(\"fill-rule\", \"evenodd\")\n      .attr(\"fill\", color)\n      .on(\"click\", click)\n      .on(\"mouseover\", mouseover)\n      .on(\"mouseout\", mouseout);\n  }\n\n  // Functions\n  function createHierarchy(datapoints) {\n    var nest = d3.nest();\n    _.each(panel.nodeKeys, function(key, depth) {\n      // Prepare formaters\n      formaters[depth] = createValueFormater(panel.styles[key]);\n\n      // Prepare nest\n      if (depth !== panel.nodeKeys.length - 1) {\n        nest = nest.key(function(d) { return d[key]; });\n      } else {\n        nest = nest.rollup(function(leaves) {\n          return leaves[0][key];\n        });\n      }\n    });\n\n    var rtn = {\n      key: panel.rootKey,\n      values: nest.entries(datapoints)\n    };\n\n    return rtn;\n  }\n\n  function createValueFormater(style) {\n    var defaultFormater = function(v) {\n      return v;\n    };\n\n    if (! style) {\n      return defaultFormater;\n    }\n\n    switch (style.type) {\n    case 'date':\n      var dateFormater = function(v) {\n        v = parseFloat(v);\n        var date = moment(v);\n        if (ctrl.dashboard.isTimezoneUtc()) {\n          date = date.utc();\n        }\n        return date.format(style.dateFormat || 'YYYY-MM-DD HH:mm:ss');\n      };\n      return dateFormater;\n      break;\n\n    case 'number':\n      var numberFormater = function(v) {\n        var valueFormater = kbn.valueFormats[style.unit];\n        v = parseFloat(v);\n        return valueFormater(v, style.decimals, null);\n      };\n      return numberFormater;\n      break;\n\n    default:\n      return defaultFormater;\n    }\n  }\n\n  function format(value, depth) {\n    var rtn = value;\n\n    if (formaters[depth]) {\n      var valueFormater = formaters[depth];\n      rtn = valueFormater(value);\n    }\n\n    return rtn;\n  }\n\n  function getAncestors(node) {\n    var rtn = [];\n    var current = node;\n    while (current.parent) {\n      rtn.unshift(current);\n      current = current.parent;\n    }\n    return rtn;\n  }\n\n  function updateTooltip(d, position) {\n    var lines = [];\n    var linkParams = [];\n    var tooltipHref = panel.linkTemplate;\n\n    var list = [];\n\n    if (d.depth > 0) {\n      var ancectors = getAncestors(d);\n      _.each(ancectors, function(ancector, i) {\n        lines.push(\n            '<li style=\"border-left: 3px solid ' + ancector.color + '\">' +\n            panel.nodeKeys[i] + ': ' + format(ancector.key, ancector.depth - 1) +\n            '</li>'\n        );\n\n        if (panel.linkTemplate) {\n          tooltipHref = tooltipHref.replace('\\$' + String(i + 1), ancector.key);\n        }\n      });\n    } else {\n      lines.push('<li>root: ' + panel.rootKey + '</li>');\n    }\n\n    var style = (d.color === 'transparent') ?\n      '' : ' style=\"border-left: 3px solid ' + d.color + '\"';\n    lines.push(\n      '<li' + style + '>' +\n      _.last(panel.nodeKeys) + ': ' + format(d.value, panel.nodeKeys.length - 1) +\n      '</li>'\n    );\n\n    if (panel.linkTemplate) {\n      tooltipHref = tooltipHref.replace(/\\/\\$\\d*/g, '');\n      lines.push('<li><a href=\"' + tooltipHref + '\" target=\"_blank\">[ link ]</a></li>');\n    }\n\n    var tooltip = d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n      .style(\"left\", position[0] + \"px\")\n      .style(\"top\",  position[1] + \"px\")\n      .classed(\"hidden\", false);\n\n    tooltip.select('ul').remove();\n    tooltip.html('<ul>' + lines.join(\"\\n\") + '</ul>');\n  }\n\n  function hideTooltip() {\n    d3.select(\"#sunburst-tooltip-\" + ctrl.panel.id)\n      .classed('hidden', true);\n  }\n}\n\n"]}